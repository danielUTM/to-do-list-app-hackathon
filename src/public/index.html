<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>To Do List</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <h1>To Do List</h1>

      <ul id="todo-list"></ul>

      <form id="add-todo-form">
        <input
          type="text"
          id="todo-title"
          placeholder="Enter a title..."
          required
        />
        <input
          type="text"
          id="todo-summary"
          placeholder="Enter a summary..."
          required
        />
        <input type="date" id="todo-due_by" />

        <button type="submit">Add</button>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script type="module">
      document.addEventListener("DOMContentLoaded", async function () {
        const tasksREQ = await fetch("http://localhost:8080/tasks").catch((e) =>
          alert("Failed"),
        );

        const tasks = await tasksREQ.json();

        const todoList = document.getElementById("todo-list");

        // render tasks
        function renderTasks(tasks) {
          todoList.innerHTML = ""; // Clear list

          tasks.forEach((task) => {
            const li = document.createElement("li");
            li.textContent = `${task.title} - Due by: ${task.due_by}`;
            if (task.completed) {
              li.classList.add("completed");
            }
            const button = document.createElement("button");
            button.onclick = async function () {
              await fetch(`http://localhost:8080/task?id=${task.id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
              }).then((response) => {
                window.location.reload();
              });
            };

            button.innerHTML = "Completed";
            li.appendChild(button);
            todoList.appendChild(li);
          });
        }

        // render with tasks
        renderTasks(tasks);

        // Form submission event handler for adding new tasks
        const addTodoForm = document.getElementById("add-todo-form");
        const todoTitle = document.getElementById("todo-title");
        const todoSummary = document.getElementById("todo-summary");
        const todoDueBy = document.getElementById("todo-due_by");

        addTodoForm.addEventListener("submit", async function (event) {
          event.preventDefault();
          const newTaskTitle = todoTitle.value.trim();
          const newTaskSummary = todoSummary.value.trim();
          const url =
            todoDueBy.value === ""
              ? `http://localhost:8080/tasks?title=${newTaskTitle}&summary=${newTaskSummary}&assigned_to=1`
              : `http://localhost:8080/tasks?title=${newTaskTitle}&summary=${newTaskSummary}&due_by=${todoDueBy.value.trim()}&assigned_to=1`;
          console.log(url);
          await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // body:JSON.stringify(newTask)
          }).then((response) => {
            window.location.reload();
          });

          todoTitle.value = "";
          todoSummary.value = "";
          todoDueBy.value = "";
          // document.getElementById("todo-list").reset();
        });
      });
    </script>
  </body>
</html>
